# Alembic Migrations

Alembic is a database migration tool associated with SqlAlchemy.
Since we use SQLAlchemy all over our codebases, it seemed natural to use it for migrations.

The purpose of database migrations is to put the database schema into source control.
The migrations generated by alembic can be run sequentially to rebuild the exact scheme to match the current API.

It can also aid in operating the API as close to zero downtime while allowing database changes easily.

# Operation

(1) run `alembic revision -m "description of the migration"` (don't make it too long, it's part of the filename)
(2) Go to `migrations/versions` and open the new file, it should be at the bottom as they are ordered by timestamp
(3) edit both the upgrade and downgrade bits
    e.g. CREATE TABLE records(...) in the upgrade, DROP TABLE records in the downgrade
(4) To apply the migration, run `alembic upgrade head`.
(5) To downgrade a migration (or more), run `alembic downgrade -<n>` where <n> is the number of migrations to revert

# Notes

(1) The downgrade is to revert, so be careful with changes not easily reverted (e.g. dropping a table or column)
(2) I just use raw SQL (see the first revision for an example) as it is simpler than the alembic ORM
(3) I would recommend, if possible, to always design commits to not impact the API
    (a) To remove a column:
        (i) First change the API to not use the column
        (ii) Then run the migration.
    (b) To add a column
        (i) To add a column, first change any API call to be agnostic to the additional column
        (ii) Run the migration
        (iii) Then change the API to use the additional column wherever needed

# Running the server

At the moment there are no env vars. The AWS credentials are stored directly on the server it is running on.
The database configuration is fetched from AWS secrets manager.
And the s3 bucket and secrets id are both hardcoded at the moment.

To run the server simply:
`python3.8 -m dataregistry.main serve`

To test in a separate window (running it locally) you can use python to hit the server a la:
`requests.post('http://localhost:5000/api/records', json={"name": "test 13", "description": "test description"})`

For testing currently change the database and s3 bucket
TODO: These should default to a dev version and on the server itself it should have an override to point to prod
