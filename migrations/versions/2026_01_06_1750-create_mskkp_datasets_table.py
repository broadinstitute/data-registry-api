"""create mskkp_datasets table

Revision ID: create_mskkp_datasets
Revises: create_sgc_gwas_files
Create Date: 2026-01-06 17:50:00.000000

"""
from alembic import op
from sqlalchemy import text

# revision identifiers, used by Alembic.
revision = 'create_mskkp_datasets'
down_revision = 'create_sgc_gwas_files'
branch_labels = None
depends_on = None


def upgrade() -> None:
    conn = op.get_bind()
    
    # Create mskkp_datasets table
    query = """
        CREATE TABLE `mskkp_datasets` (
        `id` binary(32) NOT NULL COMMENT 'uuid generated by backend api',
        `name` varchar(200) NOT NULL COMMENT 'dataset name provided by user',
        `phenotype` varchar(100) NULL COMMENT 'phenotype description (optional)',
        `ancestry` varchar(50) NOT NULL COMMENT 'ancestry code (EUR, AFR, EAS, SAS, AMR)',
        `genome_build` varchar(20) NOT NULL COMMENT 'genome build (GRCh37, GRCh38)',
        `effective_n` int NULL COMMENT 'effective sample size (optional if in file)',
        `file_name` varchar(255) NOT NULL COMMENT 'original uploaded file name',
        `file_size` bigint NOT NULL COMMENT 'file size in bytes',
        `s3_path` varchar(500) NOT NULL COMMENT 's3 key path to uploaded file',
        `uploaded_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'timestamp of upload',
        `uploaded_by` varchar(100) NOT NULL COMMENT 'username of uploader',
        `column_map` json NOT NULL COMMENT 'JSON mapping of file columns to GWAS fields',
        `metadata` json NULL COMMENT 'additional metadata',
        `status` varchar(50) NOT NULL DEFAULT 'uploaded' COMMENT 'processing status',
        `qc_log` text NULL COMMENT 'quality control log output',
        PRIMARY KEY (`id`),
        KEY `mskkp_datasets_name_idx` (`name`),
        KEY `mskkp_datasets_phenotype_idx` (`phenotype`),
        KEY `mskkp_datasets_ancestry_idx` (`ancestry`),
        KEY `mskkp_datasets_uploaded_by_idx` (`uploaded_by`),
        KEY `mskkp_datasets_status_idx` (`status`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
        """
    conn.execute(text(query))


def downgrade() -> None:
    conn = op.get_bind()
    conn.execute(text("DROP TABLE `mskkp_datasets`"))
